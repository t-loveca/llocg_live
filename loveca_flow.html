<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loveca Flow - å¯¾æˆ¦ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
    <style>
        :root {
            --primary-text: #333;
            --border-color: #000;
            --bg-color: #fff;
            --self-bg: #e6f2ff; /* è–„ã„é’ */
            --self-border: #0056b3;
            --opp-bg: #fff0f0; /* è–„ã„èµ¤ */
            --opp-border: #c82333;
            --win-bg: #ffeb3b;
        }

        * {
            box-sizing: border-box;
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
        }

        body {
            margin: 0;
            padding: 10px;
            background-color: #f4f4f4;
            color: var(--primary-text);
            padding-bottom: 80px; /* ä¸‹éƒ¨ãƒœã‚¿ãƒ³ç”¨ã‚¹ãƒšãƒ¼ã‚¹ */
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--bg-color);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            margin: 0 0 15px 0;
            font-size: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        /* ãƒ‡ãƒƒã‚­åå…¥åŠ›ã‚¨ãƒªã‚¢ */
        .deck-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
        }

        .deck-box {
            padding: 5px;
            text-align: center;
        }

        .deck-box.self { background-color: var(--self-bg); border-right: 1px solid var(--border-color); }
        .deck-box.opp { background-color: var(--opp-bg); }

        .deck-label {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 2px;
            display: block;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px; /* ã‚¹ãƒãƒ›ã§ã‚ºãƒ¼ãƒ ã—ãªã„ã‚µã‚¤ã‚º */
        }
        
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--self-border);
        }

        /* å‹åˆ©è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #winner-display {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            background-color: var(--win-bg);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 2px solid #fbc02d;
            display: none; /* JSã§åˆ¶å¾¡ */
        }

        /* ç¾åœ¨ã®ã‚¹ã‚³ã‚¢è¡¨ç¤º */
        .score-board {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
            padding: 5px;
            background: #eee;
            border-radius: 4px;
        }
        .score-count { font-size: 1.1rem; }
        .score-count.self { color: var(--self-border); }
        .score-count.opp { color: var(--opp-border); }

        /* ã‚¿ãƒ¼ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ« */
        .turn-container {
            border: 2px solid var(--border-color);
            margin-bottom: 20px;
            background: #fff;
        }

        .turn-header {
            background: #333;
            color: #fff;
            padding: 5px 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .turn-content {
            display: flex;
            flex-direction: column;
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢å…±é€š */
        .player-area {
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .player-area.opp { background-color: var(--opp-bg); }
        .player-area.self { background-color: var(--self-bg); }

        .info-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .score-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .score-input {
            width: 50px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            border: 1px solid #999;
        }

        .btn-score {
            width: 30px;
            height: 30px;
            background: #fff;
            border: 1px solid #999;
            border-radius: 4px;
            font-weight: bold;
            touch-action: manipulation;
        }

        .no-live-check {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .no-live-check input {
            margin-right: 4px;
            transform: scale(1.2);
        }

        /* ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            margin-bottom: 4px;
        }

        .card-input-wrapper {
            display: flex;
            flex-direction: column;
        }

        .card-label {
            font-size: 0.7rem;
            color: #666;
            text-align: center;
            margin-bottom: 1px;
        }
        
        .card-input {
            font-size: 0.8rem;
            text-align: center;
            padding: 4px;
            height: 36px; /* è¤‡æ•°è¡Œå¯¾å¿œ */
        }

        /* ãƒ¡ãƒ¢æ¬„ */
        .memo-area {
            padding: 5px;
            background: #f9f9f9;
        }
        .memo-input {
            width: 100%;
            height: 40px;
            resize: none;
            font-size: 0.9rem;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼æ“ä½œã‚¨ãƒªã‚¢ */
        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255,255,255,0.95);
            border-top: 1px solid #ccc;
            padding: 10px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-add {
            background-color: #333;
            color: #fff;
            width: 50%;
            font-size: 1.2rem;
        }

        .btn-sub {
            background-color: #ddd;
            color: #333;
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .win-mark {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 5px;
            vertical-align: middle;
        }
        .win-mark.active {
            background-color: gold;
            border: 1px solid orange;
            box-shadow: 0 0 5px orange;
        }
        .win-mark.inactive {
            background-color: #ddd;
            border: 1px solid #bbb;
        }

    </style>
</head>
<body>

<div class="container">
    <h1>Loveca Flow</h1>

    <div id="winner-display"></div>

    <div class="score-board">
        <div class="score-count self">è‡ªåˆ† (é’): <span id="self-total-wins">0</span>å‹</div>
        <div class="score-count opp">ç›¸æ‰‹ (èµ¤): <span id="opp-total-wins">0</span>å‹</div>
    </div>

    <div class="deck-info">
        <div class="deck-box self">
            <label class="deck-label">è‡ªåˆ†ã®ãƒ‡ãƒƒã‚­</label>
            <input type="text" id="self-deck-name" placeholder="ãƒ‡ãƒƒã‚­å" onchange="updateDeckName()">
        </div>
        <div class="deck-box opp">
            <label class="deck-label">ç›¸æ‰‹ã®ãƒ‡ãƒƒã‚­</label>
            <input type="text" id="opp-deck-name" placeholder="ãƒ‡ãƒƒã‚­å" onchange="updateDeckName()">
        </div>
    </div>

    <div id="turns-area">
        </div>
</div>

<div class="controls">
    <input type="file" id="import-file" class="file-input" accept=".json" onchange="importData(this)">
    <button class="btn btn-sub" onclick="document.getElementById('import-file').click()">èª­è¾¼</button>
    <button class="btn btn-add" onclick="addTurn()">ï¼‹ ã‚¿ãƒ¼ãƒ³è¿½åŠ </button>
    <button class="btn btn-sub" onclick="exportData()">ä¿å­˜</button>
</div>

<script>
    // ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ç®¡ç†
    let gameState = {
        selfDeckName: "",
        oppDeckName: "",
        turns: []
    };

    // åˆæœŸåŒ–
    window.onload = function() {
        addTurn(); // æœ€åˆã®ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ 
    };

    // ã‚¿ãƒ¼ãƒ³è¿½åŠ 
    function addTurn() {
        const turnIndex = gameState.turns.length;
        
        // å‰ã®ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚Œã°ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼
        let prevSelfMembers = ["", "", ""];
        let prevOppMembers = ["", "", ""];
        
        if (turnIndex > 0) {
            const prevTurn = gameState.turns[turnIndex - 1];
            prevSelfMembers = [...prevTurn.selfMembers];
            prevOppMembers = [...prevTurn.oppMembers];
        }

        const newTurn = {
            id: Date.now(),
            oppScore: 0,
            oppNoLive: true, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON
            oppMembers: prevOppMembers,
            oppLives: ["", "", ""],
            selfScore: 0,
            selfNoLive: true, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆON
            selfMembers: prevSelfMembers,
            selfLives: ["", "", ""],
            memo: ""
        };

        gameState.turns.push(newTurn);
        renderTurns();
        updateWinCounts();
    }

    // ãƒ‡ãƒƒã‚­åæ›´æ–°
    function updateDeckName() {
        gameState.selfDeckName = document.getElementById('self-deck-name').value;
        gameState.oppDeckName = document.getElementById('opp-deck-name').value;
        checkGameSet(); // ãƒ‡ãƒƒã‚­åãŒå¤‰ã‚ã£ãŸã‚‰å‹åˆ©è¡¨ç¤ºã®ãƒ‡ãƒƒã‚­åã‚‚æ›´æ–°
    }

    // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ç”¨é–¢æ•° (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æŒ‡å®š)
    function updateTurnData(index, field, value, subIndex = null) {
        if (subIndex !== null) {
            gameState.turns[index][field][subIndex] = value;
        } else {
            gameState.turns[index][field] = value;
        }
        
        // ã‚¹ã‚³ã‚¢ã‹NoLiveãƒ•ãƒ©ã‚°ãŒå¤‰ã‚ã£ãŸå ´åˆã®ã¿å†è¨ˆç®—ãƒ»è¡¨ç¤ºæ›´æ–°
        if (field === 'selfScore' || field === 'oppScore' || field === 'selfNoLive' || field === 'oppNoLive') {
            updateWinCounts();
        }
    }

    // ã‚¹ã‚³ã‚¢å¢—æ¸›ãƒœã‚¿ãƒ³
    function changeScore(index, player, delta) {
        const field = player === 'self' ? 'selfScore' : 'oppScore';
        let current = gameState.turns[index][field];
        current = parseInt(current) + delta;
        if (current < 0) current = 0;
        
        gameState.turns[index][field] = current;
        renderTurns(); // å€¤ã‚’åæ˜ ã•ã›ã‚‹ãŸã‚å†æç”»
        updateWinCounts();
    }

    // å‹åˆ©æ•°è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
    function updateWinCounts() {
        let selfWins = 0;
        let oppWins = 0;

        gameState.turns.forEach(turn => {
            const sScore = parseInt(turn.selfScore);
            const oScore = parseInt(turn.oppScore);
            const sNoLive = turn.selfNoLive;
            const oNoLive = turn.oppNoLive;

            let selfWonThisTurn = false;
            let oppWonThisTurn = false;

            // ãƒ©ã‚¤ãƒ–ãªã—ãƒã‚§ãƒƒã‚¯ãŒä»˜ã„ã¦ã„ã‚‹å ´åˆã¯å‹åˆ©ã‚«ã‚¦ãƒ³ãƒˆ+1ã—ãªã„
            // ãƒ­ã‚¸ãƒƒã‚¯ï¼š
            // 1. ã‚¹ã‚³ã‚¢æ¯”è¼ƒ
            // 2. ãƒ©ã‚¤ãƒ–ãªã—ãƒ•ãƒ©ã‚°ç¢ºèª

            if (sScore > oScore) {
                // è‡ªåˆ†ãŒå‹ã£ãŸå ´åˆã€è‡ªåˆ†ãŒãƒ©ã‚¤ãƒ–ã‚ã‚Šãªã‚‰+1
                if (!sNoLive) selfWonThisTurn = true;
            } else if (oScore > sScore) {
                // ç›¸æ‰‹ãŒå‹ã£ãŸå ´åˆã€ç›¸æ‰‹ãŒãƒ©ã‚¤ãƒ–ã‚ã‚Šãªã‚‰+1
                if (!oNoLive) oppWonThisTurn = true;
            } else {
                // åŒç‚¹ã®å ´åˆ (0å¯¾0å«ã‚€)
                // ä¸¡è€…ãƒ©ã‚¤ãƒ–ã‚ã‚Šã®å ´åˆã®ã¿åˆ¤å®šã¸
                
                // è‡ªåˆ†ãŒãƒ©ã‚¤ãƒ–ã‚ã‚Šã®å ´åˆã®åˆ¤å®š
                if (!sNoLive) {
                    if (selfWins <= 1) selfWonThisTurn = true;
                    // 2å‹æ™‚ã¯+1ã—ãªã„
                }

                // ç›¸æ‰‹ãŒãƒ©ã‚¤ãƒ–ã‚ã‚Šã®å ´åˆã®åˆ¤å®š
                if (!oNoLive) {
                    if (oppWins <= 1) oppWonThisTurn = true;
                    // 2å‹æ™‚ã¯+1ã—ãªã„
                }
            }

            if (selfWonThisTurn) selfWins++;
            if (oppWonThisTurn) oppWins++;
        });

        document.getElementById('self-total-wins').textContent = selfWins;
        document.getElementById('opp-total-wins').textContent = oppWins;

        checkGameSet(selfWins, oppWins);
    }

    // ã‚²ãƒ¼ãƒ ã‚»ãƒƒãƒˆåˆ¤å®š
    function checkGameSet(selfWins, oppWins) {
        const display = document.getElementById('winner-display');
        const selfName = gameState.selfDeckName || "è‡ªåˆ†ã®ãƒ‡ãƒƒã‚­";
        const oppName = gameState.oppDeckName || "ç›¸æ‰‹ã®ãƒ‡ãƒƒã‚­";

        if (selfWins >= 3) {
            display.style.display = 'block';
            display.textContent = `ğŸ‰ ${selfName} ã®å‹åˆ©ï¼ ğŸ‰`;
            display.style.backgroundColor = '#e6f2ff';
            display.style.borderColor = '#0056b3';
        } else if (oppWins >= 3) {
            display.style.display = 'block';
            display.textContent = `ğŸ‰ ${oppName} ã®å‹åˆ©ï¼ ğŸ‰`;
            display.style.backgroundColor = '#fff0f0';
            display.style.borderColor = '#c82333';
        } else {
            display.style.display = 'none';
        }
    }

    // æç”»é–¢æ•°
    function renderTurns() {
        const area = document.getElementById('turns-area');
        area.innerHTML = '';

        gameState.turns.forEach((turn, index) => {
            const turnDiv = document.createElement('div');
            turnDiv.className = 'turn-container';
            
            // HTMLæ§‹ç¯‰
            let html = `
                <div class="turn-header">
                    <span>Turn ${index + 1}</span>
                </div>
                <div class="turn-content">
                    <div class="player-area opp">
                        <div class="info-row">
                            <span style="font-weight:bold; color:#c82333;">ç›¸æ‰‹</span>
                            <div class="score-control">
                                <span>ã‚¹ã‚³ã‚¢</span>
                                <button class="btn-score" onclick="changeScore(${index}, 'opp', -1)">-</button>
                                <input type="number" class="score-input" value="${turn.oppScore}" readonly>
                                <button class="btn-score" onclick="changeScore(${index}, 'opp', 1)">+</button>
                            </div>
                            <label class="no-live-check">
                                <input type="checkbox" ${turn.oppNoLive ? 'checked' : ''} 
                                onchange="updateTurnData(${index}, 'oppNoLive', this.checked)"> ãƒ©ã‚¤ãƒ–ãªã—
                            </label>
                        </div>
                        <div class="cards-grid">
                            ${[0,1,2].map(i => `
                                <div class="card-input-wrapper">
                                    <span class="card-label">ãƒ¡ãƒ³ãƒãƒ¼</span>
                                    <input type="text" class="card-input" value="${turn.oppMembers[i]}" 
                                    onchange="updateTurnData(${index}, 'oppMembers', this.value, ${i})">
                                </div>
                            `).join('')}
                        </div>
                        <div class="cards-grid">
                            ${[0,1,2].map(i => `
                                <div class="card-input-wrapper">
                                    <span class="card-label">ãƒ©ã‚¤ãƒ–</span>
                                    <input type="text" class="card-input" value="${turn.oppLives[i]}" 
                                    onchange="updateTurnData(${index}, 'oppLives', this.value, ${i})">
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="player-area self">
                        <div class="info-row">
                            <span style="font-weight:bold; color:#0056b3;">è‡ªåˆ†</span>
                            <div class="score-control">
                                <span>ã‚¹ã‚³ã‚¢</span>
                                <button class="btn-score" onclick="changeScore(${index}, 'self', -1)">-</button>
                                <input type="number" class="score-input" value="${turn.selfScore}" readonly>
                                <button class="btn-score" onclick="changeScore(${index}, 'self', 1)">+</button>
                            </div>
                            <label class="no-live-check">
                                <input type="checkbox" ${turn.selfNoLive ? 'checked' : ''} 
                                onchange="updateTurnData(${index}, 'selfNoLive', this.checked)"> ãƒ©ã‚¤ãƒ–ãªã—
                            </label>
                        </div>
                         <div class="cards-grid">
                            ${[0,1,2].map(i => `
                                <div class="card-input-wrapper">
                                    <span class="card-label">ãƒ©ã‚¤ãƒ–</span>
                                    <input type="text" class="card-input" value="${turn.selfLives[i]}" 
                                    onchange="updateTurnData(${index}, 'selfLives', this.value, ${i})">
                                </div>
                            `).join('')}
                        </div>
                        <div class="cards-grid">
                            ${[0,1,2].map(i => `
                                <div class="card-input-wrapper">
                                    <span class="card-label">ãƒ¡ãƒ³ãƒãƒ¼</span>
                                    <input type="text" class="card-input" value="${turn.selfMembers[i]}" 
                                    onchange="updateTurnData(${index}, 'selfMembers', this.value, ${i})">
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="memo-area">
                        <textarea class="memo-input" placeholder="ãƒ¡ãƒ¢" 
                        onchange="updateTurnData(${index}, 'memo', this.value)">${turn.memo}</textarea>
                    </div>
                </div>
            `;
            
            turnDiv.innerHTML = html;
            area.appendChild(turnDiv);
        });
        
        // ãƒ‡ãƒƒã‚­åInputã¸åæ˜ ï¼ˆå†æç”»æ™‚ï¼‰
        document.getElementById('self-deck-name').value = gameState.selfDeckName;
        document.getElementById('opp-deck-name').value = gameState.oppDeckName;
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (JSON)
    function exportData() {
        const now = new Date();
        const filename = `lovecaflow_${now.getFullYear()}${String(now.getMonth()+1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}.json`;
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(gameState));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", filename);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    function importData(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedState = JSON.parse(e.target.result);
                if (importedState.turns) {
                    gameState = importedState;
                    renderTurns();
                    updateWinCounts();
                    alert("ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
                } else {
                    alert("ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™");
                }
            } catch (err) {
                alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            }
        };
        reader.readAsText(file);
    }

</script>

</body>
</html>