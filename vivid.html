<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIVID WORLD ç¢ºç‡è¨ˆç®—ãƒ„ãƒ¼ãƒ«</title>
    <style>
        :root {
            --primary-color: #6200ea; /* æ¿ƒã„ç´« */
            --secondary-color: #304ffe; /* æ¿ƒã„é’ */
            --accent-color: #00b0ff; /* æ°´è‰² */
            --bg-color: #f3e5f5; /* è–„ã„ç´«èƒŒæ™¯ */
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #e0e0e0;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 10px;
            margin: 0;
            line-height: 1.5;
        }

        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(48, 79, 254, 0.1);
            border-top: 6px solid var(--primary-color);
        }

        h1 {
            font-size: 20px;
            margin: 5px 0 15px 0;
            color: var(--primary-color);
            text-align: center;
            letter-spacing: 0.05em;
        }

        p.description {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-bottom: 20px;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        .control-panel {
            background: #e8eaf6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary-color);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: space-between;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            flex: 1 1 45%; /* 2åˆ—é…ç½® */
            min-width: 120px;
            align-items: flex-start;
        }

        label {
            font-size: 12px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            width: 100%;
        }

        input[type="number"] {
            padding: 8px;
            border: 1px solid #c5cae9;
            border-radius: 6px;
            width: 100%;
            font-size: 16px;
            text-align: center;
            outline: none;
            background: #fff;
            -moz-appearance: textfield; /* Firefoxç”¨ */
        }
        /* ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™ */
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        .unit-label {
            font-size: 12px;
            margin-left: 5px;
            white-space: nowrap;
            color: #666;
        }

        h2 {
            font-size: 16px;
            margin-top: 25px;
            margin-bottom: 10px;
            color: var(--secondary-color);
            border-bottom: 2px solid #e8eaf6;
            padding-bottom: 5px;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ - ã‚¹ãƒãƒ›å¯¾å¿œ */
        .table-wrapper {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th {
            background-color: #e8eaf6;
            color: var(--primary-color);
            padding: 10px 5px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            line-height: 1.2;
        }

        td {
            padding: 8px 2px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            vertical-align: middle;
        }

        /* åˆ—å¹…èª¿æ•´ */
        .col-heart { width: 45%; }
        .col-niji  { width: 15%; }
        .col-count { width: 20%; }
        .col-del   { width: 20%; }

        /* ãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
        .heart-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 4px;
        }

        .heart-check {
            cursor: pointer;
            font-size: 1.4rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f9f9f9;
            opacity: 0.3;
            filter: grayscale(100%);
            border: 1px solid #ddd;
            transition: opacity 0.1s, transform 0.1s;
            -webkit-tap-highlight-color: transparent;
        }

        .heart-check.checked {
            opacity: 1.0;
            filter: grayscale(0%);
            background-color: #fff;
            border-color: var(--accent-color);
            transform: scale(1.1);
        }

        .heart-check input { display: none; }

        /* è™¹ãƒ¶å’²ãƒˆã‚°ãƒ« */
        .niji-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: #555;
            cursor: pointer;
            height: 100%;
        }
        
        .niji-label input {
            margin-top: 4px;
            width: 20px;
            height: 20px;
            accent-color: var(--primary-color);
        }

        /* æšæ•°å…¥åŠ› */
        .card-count {
            padding: 5px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            max-width: 50px;
        }

        /* ãƒœã‚¿ãƒ³é¡ */
        .btn {
            cursor: pointer;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            transition: opacity 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:active { transform: scale(0.98); }

        .btn-add {
            background-color: #7e57c2;
            color: white;
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            font-size: 14px;
            border: 1px dashed #b39ddb;
        }

        .btn-remove {
            background-color: #ef5350;
            color: white;
            padding: 6px 0;
            width: 80%;
            font-size: 11px;
            border-radius: 4px;
        }

        .btn-calc {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: white;
            font-size: 18px;
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            letter-spacing: 0.05em;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(98, 0, 234, 0.3);
        }

        .deck-status {
            margin-top: 10px;
            text-align: right;
            font-weight: bold;
            color: var(--secondary-color);
            font-size: 14px;
        }
        .deck-status.error { color: #d32f2f; }

        /* çµæœã‚¨ãƒªã‚¢ */
        .result-area {
            margin-top: 20px;
            padding: 20px 15px;
            background: linear-gradient(to bottom right, #e8eaf6, #f3e5f5);
            border-radius: 12px;
            border: 2px solid #c5cae9;
            text-align: center;
            display: none;
        }

        .result-title {
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .result-percent {
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            line-height: 1.1;
        }

        .expectation-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3åˆ—å›ºå®š */
            gap: 8px;
            margin-top: 15px;
            border-top: 1px solid #d1c4e9;
            padding-top: 15px;
        }
        
        .exp-item {
            background: #fff;
            padding: 8px 2px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .exp-icon { font-size: 20px; line-height: 1; margin-bottom: 2px; }
        .exp-val { font-weight: bold; font-size: 15px; color: #333; }
        .exp-label { font-size: 10px; color: #888; }

        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å‘ã‘ã®å¾®èª¿æ•´ */
        @media (max-width: 480px) {
            body { padding: 8px; }
            .container { padding: 12px; }
            .heart-check { width: 26px; height: 26px; font-size: 1.2rem; }
            .btn-calc { font-size: 16px; padding: 12px; }
            .result-percent { font-size: 36px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>VIVID WORLD ç¢ºç‡è¨ˆç®—</h1>
    <p class="description">
        ã‚¨ãƒ¼ãƒ«ã§ã€Œè™¹ãƒ¶å’²ã€ãƒ¡ãƒ³ãƒãƒ¼ã«ã‚ˆã‚‹å…¨6è‰²é”æˆç¢ºç‡ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
    </p>

    <div class="control-panel">
        <div class="control-group">
            <label>ã‚¨ãƒ¼ãƒ«æšæ•°</label>
            <div class="input-wrapper">
                <input type="number" id="yellCount" value="3" min="1" max="40" inputmode="numeric">
                <span class="unit-label">æš</span>
            </div>
        </div>

        <div class="control-group">
            <label>ãƒ‡ãƒƒã‚­å†…ã®ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰</label>
            <div class="input-wrapper">
                <input type="number" id="liveCardCount" value="12" min="0" max="60" inputmode="numeric" onchange="updateDeckCount()">
                <span class="unit-label">æš(å¯¾è±¡å¤–)</span>
            </div>
        </div>
    </div>

    <h2>ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰æ§‹æˆ</h2>
    <div class="table-wrapper">
        <table id="cardTable">
            <thead>
                <tr>
                    <th class="col-heart">ãƒãƒ¼ãƒˆ<br><span style="font-size:10px; font-weight:normal;">(è™¹ãƒ¶å’²ã®ã¿)</span></th>
                    <th class="col-niji">è™¹</th>
                    <th class="col-count">æšæ•°</th>
                    <th class="col-del"></th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
    <button class="btn btn-add" onclick="addCardRow()">ï¼‹ è¡Œã‚’è¿½åŠ </button>

    <div class="deck-status" id="deckStatus">ãƒ‡ãƒƒã‚­åˆè¨ˆ: 12æš</div>

    <button class="btn btn-calc" onclick="calculateExact()">è¨ˆç®—ã‚’å®Ÿè¡Œ</button>

    <div class="result-area" id="resultArea">
        <div class="result-title">ã‚¹ã‚³ã‚¢ï¼‹1 æ¡ä»¶é”æˆç‡</div>
        <div class="result-percent" id="resultPercent">--%</div>
        
        <div style="text-align: left; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px; padding-left: 5px;">â–¼ å„è‰²ã®æœŸå¾…å€‹æ•°</div>
        <div class="expectation-grid" id="expectationGrid">
            </div>
        <div style="margin-top: 10px; font-size: 10px; color: #999; text-align: right;">å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³æ•°: <span id="totalCases"></span></div>
    </div>
</div>

<script>
    // ãƒãƒ¼ãƒˆå®šç¾©
    const HEARTS = [
        { color: 'pink', label: 'ğŸ’—', name: 'æ¡ƒ' },
        { color: 'red', label: 'â¤ï¸', name: 'èµ¤' },
        { color: 'yellow', label: 'ğŸ’›', name: 'é»„' },
        { color: 'green', label: 'ğŸ’š', name: 'ç·‘' },
        { color: 'blue', label: 'ğŸ’™', name: 'é’' },
        { color: 'purple', label: 'ğŸ’œ', name: 'ç´«' }
    ];

    // åˆæœŸåŒ–ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§1è¡Œã ã‘è¿½åŠ ã™ã‚‹
    window.onload = function() {
        addCardRow(true, [0], 4); // ä¾‹ã¨ã—ã¦è™¹ãƒ¶å’²ONã€ãƒ”ãƒ³ã‚¯ã€4æšã§åˆæœŸåŒ–
        updateDeckCount();
    };

    // è¡Œè¿½åŠ é–¢æ•°
    function addCardRow(isNiji = true, colors = [], count = 4) {
        const tbody = document.querySelector('#cardTable tbody');
        const tr = document.createElement('tr');

        // ãƒãƒ¼ãƒˆé¸æŠã‚»ãƒ«
        let heartHtml = '<div class="heart-container">';
        HEARTS.forEach((h, index) => {
            const isChecked = colors.includes(index) ? 'checked' : '';
            heartHtml += `
                <label class="heart-check ${isChecked}" title="${h.name}">
                    ${h.label}
                    <input type="checkbox" value="${index}" onchange="toggleHeart(this)" ${isChecked ? 'checked' : ''}>
                </label>
            `;
        });
        heartHtml += '</div>';
        
        const tdHeart = document.createElement('td');
        tdHeart.innerHTML = heartHtml;
        tr.appendChild(tdHeart);

        // è™¹ãƒ¶å’²ãƒ•ãƒ©ã‚°
        const tdNiji = document.createElement('td');
        tdNiji.innerHTML = `
            <label class="niji-label">
                <span>å¯¾è±¡</span>
                <input type="checkbox" class="niji-flag" ${isNiji ? 'checked' : ''} onchange="toggleHeartOpacity(this)">
            </label>
        `;
        tr.appendChild(tdNiji);

        // æšæ•°
        const tdCount = document.createElement('td');
        tdCount.innerHTML = `<input type="number" class="card-count" value="${count}" min="1" max="4" inputmode="numeric" onchange="updateDeckCount()">`;
        tr.appendChild(tdCount);

        // å‰Šé™¤ãƒœã‚¿ãƒ³
        const tdAction = document.createElement('td');
        tdAction.innerHTML = `<button class="btn btn-remove" onclick="removeRow(this)">å‰Šé™¤</button>`;
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
        
        // åˆæœŸçŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
        toggleHeartOpacity(tr.querySelector('.niji-flag'));
        updateDeckCount();
    }

    function removeRow(btn) {
        const row = btn.closest('tr');
        row.remove();
        updateDeckCount();
    }

    function toggleHeart(input) {
        const label = input.parentElement;
        if (input.checked) {
            label.classList.add('checked');
        } else {
            label.classList.remove('checked');
        }
    }

    // è™¹ãƒ¶å’²ãƒ•ãƒ©ã‚°ãŒOFFã®ã¨ãã¯ãƒãƒ¼ãƒˆã‚’è–„ãã™ã‚‹
    function toggleHeartOpacity(checkbox) {
        const row = checkbox.closest('tr');
        const heartContainer = row.querySelector('.heart-container');
        if (checkbox.checked) {
            heartContainer.style.opacity = '1';
            heartContainer.style.pointerEvents = 'auto';
        } else {
            heartContainer.style.opacity = '0.15'; // è–„ãã™ã‚‹
        }
    }

    function updateDeckCount() {
        const liveCount = parseInt(document.getElementById('liveCardCount').value) || 0;
        let memberCount = 0;
        document.querySelectorAll('.card-count').forEach(input => {
            memberCount += parseInt(input.value) || 0;
        });
        const total = liveCount + memberCount;
        const statusEl = document.getElementById('deckStatus');
        statusEl.textContent = `ãƒ‡ãƒƒã‚­åˆè¨ˆ: ${total}æš`;
        
        if(total < 1) {
            statusEl.classList.add('error');
        } else {
            statusEl.classList.remove('error');
        }
    }

    // å³å¯†è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (å‹•çš„è¨ˆç”»æ³•)
    function calculateExact() {
        const yellCount = parseInt(document.getElementById('yellCount').value);
        const liveCount = parseInt(document.getElementById('liveCardCount').value);
        
        // ãƒ‡ãƒƒã‚­æƒ…å ±ã®æ§‹ç¯‰
        let deck = [];

        // ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ (mask=0)
        for(let i=0; i<liveCount; i++) {
            deck.push({ mask: 0, isNiji: false, colorSet: [] });
        }

        // ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰
        const rows = document.querySelectorAll('#cardTable tbody tr');
        rows.forEach(row => {
            const count = parseInt(row.querySelector('.card-count').value) || 0;
            const isNiji = row.querySelector('.niji-flag').checked;
            
            let mask = 0;
            let colorSet = [];
            
            if (isNiji) {
                const colorChecks = row.querySelectorAll('.heart-check input:checked');
                colorChecks.forEach(chk => {
                    const colorIdx = parseInt(chk.value);
                    mask |= (1 << colorIdx); // ãƒ“ãƒƒãƒˆã‚’ç«‹ã¦ã‚‹
                    colorSet.push(colorIdx);
                });
            }

            for(let i=0; i<count; i++) {
                deck.push({ mask: mask, isNiji: isNiji, colorSet: colorSet });
            }
        });

        const deckSize = deck.length;

        if (deckSize < yellCount) {
            alert("ãƒ‡ãƒƒã‚­æšæ•°ãŒã‚¨ãƒ¼ãƒ«æšæ•°ã‚ˆã‚Šå°‘ãªã„ãŸã‚è¨ˆç®—ã§ãã¾ã›ã‚“ã€‚");
            return;
        }

        // --- 1. ç¢ºç‡ã®å³å¯†è¨ˆç®— (DP) ---
        // dp[j][mask] = jæšé¸ã‚“ã ã¨ãã«ã€è‰²ãŒ mask (0~63) ã®çŠ¶æ…‹ã«ãªã‚‹çµ„ã¿åˆã‚ã›æ•° (BigInt)
        let currentDP = Array.from({ length: yellCount + 1 }, () => new Array(64).fill(0n));
        currentDP[0][0] = 1n;

        for (let i = 0; i < deckSize; i++) {
            const cardMask = deck[i].mask;
            // jæšé¸ã‚“ã§ã„ã‚‹çŠ¶æ…‹ã‹ã‚‰ã€ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ j+1æšã«ã™ã‚‹é·ç§»
            for (let j = yellCount - 1; j >= 0; j--) {
                for (let m = 0; m < 64; m++) {
                    if (currentDP[j][m] > 0n) {
                        const nextMask = m | cardMask;
                        currentDP[j + 1][nextMask] += currentDP[j][m];
                    }
                }
            }
        }

        // è¨ˆç®—çµæœ
        let totalCombinations = 0n;
        for (let m = 0; m < 64; m++) {
            totalCombinations += currentDP[yellCount][m];
        }

        // æˆåŠŸäº‹è±¡: maskãŒ63 (å…¨è‰²æƒã£ã¦ã„ã‚‹) ã®çµ„ã¿åˆã‚ã›
        const successCombinations = currentDP[yellCount][63];

        // ç¢ºç‡è¨ˆç®— (ç²¾åº¦ç¢ºä¿)
        let probability = 0;
        if (totalCombinations > 0n) {
            const precision = 10000n;
            const probabilityBigInt = (successCombinations * precision * 100n) / totalCombinations;
            probability = Number(probabilityBigInt) / Number(precision);
        }

        // --- 2. æœŸå¾…å€‹æ•°ã®è¨ˆç®— ---
        let colorCounts = [0, 0, 0, 0, 0, 0];
        deck.forEach(card => {
            if (card.isNiji) {
                card.colorSet.forEach(cIdx => {
                    colorCounts[cIdx]++;
                });
            }
        });

        let expectedValues = colorCounts.map(count => {
            if (deckSize === 0) return 0;
            return (count / deckSize) * yellCount;
        });

        // --- çµæœè¡¨ç¤º ---
        const resultArea = document.getElementById('resultArea');
        const resultPercent = document.getElementById('resultPercent');
        const expectationGrid = document.getElementById('expectationGrid');
        const totalCases = document.getElementById('totalCases');

        resultArea.style.display = 'block';
        
        // å°æ•°ç¬¬2ä½ã¾ã§
        resultPercent.textContent = `${probability.toFixed(2)}%`;
        
        // æœŸå¾…å€¤ã‚°ãƒªãƒƒãƒ‰
        let gridHtml = '';
        expectedValues.forEach((val, idx) => {
            const h = HEARTS[idx];
            gridHtml += `
                <div class="exp-item">
                    <span class="exp-icon">${h.label}</span>
                    <div class="exp-val">${val.toFixed(2)}</div>
                    <div class="exp-label">å€‹</div>
                </div>
            `;
        });
        expectationGrid.innerHTML = gridHtml;

        // å…¨é€šã‚Šæ•°è¡¨ç¤º
        let totalStr = totalCombinations.toString();
        if (totalStr.length > 12) {
            totalStr = totalStr[0] + "." + totalStr.substring(1, 3) + "e+" + (totalStr.length - 1);
        }
        totalCases.textContent = totalStr;
        
        // çµæœã‚¨ãƒªã‚¢ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        resultArea.scrollIntoView({behavior: 'smooth', block: 'nearest'});
    }
</script>

</body>
</html>