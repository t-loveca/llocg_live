<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIVID WORLD ç¢ºç‡è¨ˆç®—ãƒ„ãƒ¼ãƒ«</title>
    <style>
        :root {
            --primary-color: #6200ea; /* æ¿ƒã„ç´« */
            --secondary-color: #304ffe; /* æ¿ƒã„é’ */
            --accent-color: #00b0ff; /* æ°´è‰² */
            --bg-color: #f3e5f5; /* è–„ã„ç´«èƒŒæ™¯ */
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #e0e0e0;
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(48, 79, 254, 0.15);
            border-top: 6px solid var(--primary-color);
        }

        h1 {
            font-size: 24px;
            margin: 0 0 10px 0;
            color: var(--primary-color);
            text-align: center;
            letter-spacing: 0.05em;
        }

        p.description {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 25px;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        .control-panel {
            background: #e8eaf6;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 5px solid var(--secondary-color);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-around;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            font-weight: bold;
            color: #2c3e50;
            white-space: nowrap;
        }

        input[type="number"] {
            padding: 8px;
            border: 2px solid #c5cae9;
            border-radius: 6px;
            width: 70px;
            font-size: 16px;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus {
            border-color: var(--secondary-color);
        }

        h2 {
            font-size: 18px;
            margin-top: 30px;
            color: var(--secondary-color);
            border-bottom: 2px solid #e8eaf6;
            padding-bottom: 8px;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .table-wrapper {
            overflow-x: auto; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ */
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-top: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px; /* æœ€ä½å¹…ã‚’ç¢ºä¿ã—ã¦å´©ã‚Œã‚’é˜²ã */
        }

        th {
            background-color: #e8eaf6;
            color: var(--primary-color);
            padding: 12px;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 10px 5px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* ãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
        .heart-container {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .heart-check {
            cursor: pointer;
            font-size: 1.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #f5f5f5;
            opacity: 0.4;
            filter: grayscale(100%);
            transition: all 0.2s ease;
            user-select: none;
            border: 1px solid #ddd;
        }

        .heart-check:hover {
            opacity: 0.7;
            transform: scale(1.05);
        }

        .heart-check.checked {
            opacity: 1.0;
            filter: grayscale(0%);
            background-color: #fff;
            border-color: var(--accent-color);
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .heart-check input {
            display: none;
        }

        /* è™¹ãƒ¶å’²ãƒ•ãƒ©ã‚° */
        .niji-label {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
            color: #555;
            cursor: pointer;
        }
        
        .niji-label input {
            margin-top: 4px;
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
            cursor: pointer;
        }

        /* ãƒœã‚¿ãƒ³é¡ */
        .btn {
            cursor: pointer;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-add {
            background-color: #7e57c2;
            color: white;
            width: 100%;
            margin-top: 15px;
            border: 1px dashed #b39ddb;
            display: block;
        }
        .btn-add:hover {
            background-color: #673ab7;
            border-style: solid;
        }

        .btn-remove {
            background-color: #ef5350;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }
        .btn-remove:hover {
            background-color: #d32f2f;
        }

        .btn-calc {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: white;
            font-size: 18px;
            width: 100%;
            padding: 16px;
            margin-top: 30px;
            letter-spacing: 0.1em;
            border-radius: 8px;
        }
        .btn-calc:hover {
            box-shadow: 0 6px 20px rgba(98, 0, 234, 0.3);
            transform: translateY(-2px);
        }

        .deck-status {
            margin-top: 15px;
            text-align: right;
            font-weight: bold;
            color: var(--secondary-color);
            font-size: 15px;
        }
        .deck-status.error {
            color: #d32f2f;
        }

        /* çµæœã‚¨ãƒªã‚¢ */
        .result-area {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(to bottom right, #e8eaf6, #f3e5f5);
            border-radius: 12px;
            border: 2px solid #c5cae9;
            text-align: center;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .result-title {
            font-size: 16px;
            color: #555;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .result-percent {
            font-size: 42px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .expectation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
            margin-top: 20px;
            border-top: 1px solid #d1c4e9;
            padding-top: 20px;
        }
        
        .exp-item {
            background: #fff;
            padding: 10px 5px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .exp-icon { font-size: 22px; margin-bottom: 5px; }
        .exp-val { font-weight: bold; font-size: 16px; color: #333; }
        .exp-label { font-size: 10px; color: #777; }

    </style>
</head>
<body>

<div class="container">
    <h1>VIVID WORLD ç¢ºç‡è¨ˆç®—</h1>
    <p class="description">
        ã‚¨ãƒ¼ãƒ«ã§ã€Œè™¹ãƒ¶å’²ã€ãƒ¡ãƒ³ãƒãƒ¼ã«ã‚ˆã‚‹å…¨6è‰²é”æˆç¢ºç‡ã‚’è¨ˆç®—ã—ã¾ã™ã€‚<br>
    </p>

    <div class="control-panel">
        <div class="control-group">
            <label>ã‚¨ãƒ¼ãƒ«æšæ•° (ãƒ–ãƒ¬ãƒ¼ãƒ‰æ•°)</label>
            <input type="number" id="yellCount" value="3" min="1" max="40">
        </div>

        <div class="control-group">
            <label>ãƒ‡ãƒƒã‚­å†…ã®ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰</label>
            <input type="number" id="liveCardCount" value="12" min="0" max="60" onchange="updateDeckCount()">
            <span style="font-size: 0.9em; margin-left: 5px;">æš (å¯¾è±¡å¤–)</span>
        </div>
    </div>

    <h2>ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰æ§‹æˆ</h2>
    <div class="table-wrapper">
        <table id="cardTable">
            <thead>
                <tr>
                    <th width="50%">ãƒãƒ¼ãƒˆã®è‰² (è™¹ãƒ¶å’²ã®ã¿æœ‰åŠ¹)</th>
                    <th width="15%">è™¹ãƒ¶å’²</th>
                    <th width="20%">æšæ•°</th>
                    <th width="15%">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
    <button class="btn btn-add" onclick="addCardRow()">ï¼‹ ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ </button>

    <div class="deck-status" id="deckStatus">ãƒ‡ãƒƒã‚­åˆè¨ˆ: 12æš</div>

    <button class="btn btn-calc" onclick="calculateExact()">è¨ˆç®—ã‚’å®Ÿè¡Œ</button>

    <div class="result-area" id="resultArea">
        <div class="result-title">ã‚¹ã‚³ã‚¢ï¼‹1 æ¡ä»¶é”æˆç‡ (6è‰²ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ)</div>
        <div class="result-percent" id="resultPercent">--%</div>
        
        <div style="text-align: left; font-size: 14px; font-weight: bold; color: #555; margin-bottom: 10px; padding-left: 5px;">â–¼ å„è‰²ã®æœŸå¾…å€‹æ•° (å¹³å‡å‡ºç¾æ•°)</div>
        <div class="expectation-grid" id="expectationGrid">
            </div>
        <div style="margin-top: 15px; font-size: 12px; color: #888; text-align: right;">è¨ˆç®—ä¸Šã®å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³æ•°: <span id="totalCases"></span>é€šã‚Š</div>
    </div>
</div>

<script>
    // ãƒãƒ¼ãƒˆå®šç¾©
    const HEARTS = [
        { color: 'pink', label: 'ğŸ’—', name: 'æ¡ƒ' },
        { color: 'red', label: 'â¤ï¸', name: 'èµ¤' },
        { color: 'yellow', label: 'ğŸ’›', name: 'é»„' },
        { color: 'green', label: 'ğŸ’š', name: 'ç·‘' },
        { color: 'blue', label: 'ğŸ’™', name: 'é’' },
        { color: 'purple', label: 'ğŸ’œ', name: 'ç´«' }
    ];

    // åˆæœŸåŒ–ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§1è¡Œã ã‘è¿½åŠ ã™ã‚‹
    window.onload = function() {
        addCardRow(true, [0], 4); // ä¾‹ã¨ã—ã¦è™¹ãƒ¶å’²ONã€ãƒ”ãƒ³ã‚¯ã€4æšã§åˆæœŸåŒ–
        updateDeckCount();
    };

    // è¡Œè¿½åŠ é–¢æ•°
    function addCardRow(isNiji = true, colors = [], count = 4) {
        const tbody = document.querySelector('#cardTable tbody');
        const tr = document.createElement('tr');

        // ãƒãƒ¼ãƒˆé¸æŠã‚»ãƒ«
        let heartHtml = '<div class="heart-container">';
        HEARTS.forEach((h, index) => {
            const isChecked = colors.includes(index) ? 'checked' : '';
            heartHtml += `
                <label class="heart-check ${isChecked}" title="${h.name}">
                    ${h.label}
                    <input type="checkbox" value="${index}" onchange="toggleHeart(this)" ${isChecked ? 'checked' : ''}>
                </label>
            `;
        });
        heartHtml += '</div>';
        
        const tdHeart = document.createElement('td');
        tdHeart.innerHTML = heartHtml;
        tr.appendChild(tdHeart);

        // è™¹ãƒ¶å’²ãƒ•ãƒ©ã‚°
        const tdNiji = document.createElement('td');
        tdNiji.innerHTML = `
            <label class="niji-label">
                <input type="checkbox" class="niji-flag" ${isNiji ? 'checked' : ''} onchange="toggleHeartOpacity(this)">
                å¯¾è±¡
            </label>
        `;
        tr.appendChild(tdNiji);

        // æšæ•°
        const tdCount = document.createElement('td');
        tdCount.innerHTML = `<input type="number" class="card-count" value="${count}" min="1" max="4" onchange="updateDeckCount()">`;
        tr.appendChild(tdCount);

        // å‰Šé™¤ãƒœã‚¿ãƒ³
        const tdAction = document.createElement('td');
        tdAction.innerHTML = `<button class="btn btn-remove" onclick="removeRow(this)">å‰Šé™¤</button>`;
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
        
        // åˆæœŸçŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
        toggleHeartOpacity(tr.querySelector('.niji-flag'));
        updateDeckCount();
    }

    function removeRow(btn) {
        const row = btn.closest('tr');
        // è¡ŒãŒ1ã¤ã—ã‹ãªã„å ´åˆã¯å‰Šé™¤ã•ã›ãªã„ã€ã‚ã‚‹ã„ã¯å‰Šé™¤ã—ã¦ç©ºã«ã™ã‚‹ã‹
        // ä»Šå›ã¯å‰Šé™¤å¯èƒ½ã«ã—ã¦ã€å¿…è¦ãªã‚‰è¿½åŠ ã—ã¦ã‚‚ã‚‰ã†å½¢å¼
        row.remove();
        updateDeckCount();
    }

    function toggleHeart(input) {
        const label = input.parentElement;
        if (input.checked) {
            label.classList.add('checked');
        } else {
            label.classList.remove('checked');
        }
    }

    // è™¹ãƒ¶å’²ãƒ•ãƒ©ã‚°ãŒOFFã®ã¨ãã¯ãƒãƒ¼ãƒˆã‚’è–„ãã™ã‚‹ï¼ˆè¨ˆç®—å¯¾è±¡å¤–ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ï¼‰
    function toggleHeartOpacity(checkbox) {
        const row = checkbox.closest('tr');
        const heartContainer = row.querySelector('.heart-container');
        if (checkbox.checked) {
            heartContainer.style.opacity = '1';
            heartContainer.style.pointerEvents = 'auto';
        } else {
            heartContainer.style.opacity = '0.3';
            // è¦–è¦šçš„ã«ç„¡åŠ¹åŒ–
        }
    }

    function updateDeckCount() {
        const liveCount = parseInt(document.getElementById('liveCardCount').value) || 0;
        let memberCount = 0;
        document.querySelectorAll('.card-count').forEach(input => {
            memberCount += parseInt(input.value) || 0;
        });
        const total = liveCount + memberCount;
        const statusEl = document.getElementById('deckStatus');
        statusEl.textContent = `ãƒ‡ãƒƒã‚­åˆè¨ˆ: ${total}æš`;
        
        if(total < 1) {
            statusEl.classList.add('error');
        } else {
            statusEl.classList.remove('error');
        }
    }

    // å³å¯†è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (å‹•çš„è¨ˆç”»æ³•)
    function calculateExact() {
        const yellCount = parseInt(document.getElementById('yellCount').value);
        const liveCount = parseInt(document.getElementById('liveCardCount').value);
        
        // ãƒ‡ãƒƒã‚­æƒ…å ±ã®æ§‹ç¯‰
        let deck = [];

        // ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ (mask=0)
        for(let i=0; i<liveCount; i++) {
            deck.push({ mask: 0, isNiji: false, colorSet: [] });
        }

        // ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰
        const rows = document.querySelectorAll('#cardTable tbody tr');
        rows.forEach(row => {
            const count = parseInt(row.querySelector('.card-count').value) || 0;
            const isNiji = row.querySelector('.niji-flag').checked;
            
            let mask = 0;
            let colorSet = [];
            
            if (isNiji) {
                const colorChecks = row.querySelectorAll('.heart-check input:checked');
                colorChecks.forEach(chk => {
                    const colorIdx = parseInt(chk.value);
                    mask |= (1 << colorIdx); // ãƒ“ãƒƒãƒˆã‚’ç«‹ã¦ã‚‹
                    colorSet.push(colorIdx);
                });
            }

            for(let i=0; i<count; i++) {
                deck.push({ mask: mask, isNiji: isNiji, colorSet: colorSet });
            }
        });

        const deckSize = deck.length;

        if (deckSize < yellCount) {
            alert("ãƒ‡ãƒƒã‚­æšæ•°ãŒã‚¨ãƒ¼ãƒ«æšæ•°ã‚ˆã‚Šå°‘ãªã„ãŸã‚è¨ˆç®—ã§ãã¾ã›ã‚“ã€‚\nã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã‹ã‚¨ãƒ¼ãƒ«æšæ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        // --- 1. ç¢ºç‡ã®å³å¯†è¨ˆç®— (DP) ---
        // dp[j][mask] = jæšé¸ã‚“ã ã¨ãã«ã€è‰²ãŒ mask (0~63) ã®çŠ¶æ…‹ã«ãªã‚‹çµ„ã¿åˆã‚ã›æ•° (BigInt)
        let currentDP = Array.from({ length: yellCount + 1 }, () => new Array(64).fill(0n));
        currentDP[0][0] = 1n;

        for (let i = 0; i < deckSize; i++) {
            const cardMask = deck[i].mask;
            
            // jæšé¸ã‚“ã§ã„ã‚‹çŠ¶æ…‹ã‹ã‚‰ã€ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ j+1æšã«ã™ã‚‹é·ç§»
            // é‡è¤‡åˆ©ç”¨ã‚’é˜²ããŸã‚ã€jã¯å¤§ãã„æ–¹ã‹ã‚‰å›ã™
            for (let j = yellCount - 1; j >= 0; j--) {
                for (let m = 0; m < 64; m++) {
                    if (currentDP[j][m] > 0n) {
                        const nextMask = m | cardMask;
                        currentDP[j + 1][nextMask] += currentDP[j][m];
                    }
                }
            }
        }

        // è¨ˆç®—çµæœ
        // å…¨äº‹è±¡: yellCountæšé¸ã¶ã™ã¹ã¦ã®çµ„ã¿åˆã‚ã›ã®å’Œ (nCk)
        let totalCombinations = 0n;
        for (let m = 0; m < 64; m++) {
            totalCombinations += currentDP[yellCount][m];
        }

        // æˆåŠŸäº‹è±¡: maskãŒ63 (111111 -> å…¨è‰²æƒã£ã¦ã„ã‚‹) ã®çµ„ã¿åˆã‚ã›
        const successCombinations = currentDP[yellCount][63];

        // ç¢ºç‡è¨ˆç®—
        let probability = 0;
        if (totalCombinations > 0n) {
            // ç²¾åº¦ç¢ºä¿ã®ãŸã‚10000å€ã—ã¦è¨ˆç®—
            const precision = 10000n;
            const probabilityBigInt = (successCombinations * precision * 100n) / totalCombinations;
            probability = Number(probabilityBigInt) / Number(precision);
        }

        // --- 2. æœŸå¾…å€‹æ•°ã®è¨ˆç®— (å³å¯†è§£) ---
        // å„è‰²ã”ã¨ã®æœŸå¾…å€¤ = (ãƒ‡ãƒƒã‚­å†…ã®ãã®è‰²ã®ç·æ•° / ãƒ‡ãƒƒã‚­æšæ•°) * ã‚¨ãƒ¼ãƒ«æšæ•°
        // â€» è™¹ãƒ¶å’²ãƒ•ãƒ©ã‚°ãŒONã®ã‚«ãƒ¼ãƒ‰ã®ã¿ãŒæŒã¤è‰²ãŒå¯¾è±¡
        let colorCounts = [0, 0, 0, 0, 0, 0]; // ãƒ”ãƒ³ã‚¯, èµ¤, é»„, ç·‘, é’, ç´«
        
        deck.forEach(card => {
            if (card.isNiji) {
                card.colorSet.forEach(cIdx => {
                    colorCounts[cIdx]++;
                });
            }
        });

        let expectedValues = colorCounts.map(count => {
            if (deckSize === 0) return 0;
            return (count / deckSize) * yellCount;
        });

        // --- çµæœè¡¨ç¤º ---
        const resultArea = document.getElementById('resultArea');
        const resultPercent = document.getElementById('resultPercent');
        const expectationGrid = document.getElementById('expectationGrid');
        const totalCases = document.getElementById('totalCases');

        resultArea.style.display = 'block';
        resultPercent.textContent = `${probability.toFixed(2)}%`;
        
        // æœŸå¾…å€¤ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
        let gridHtml = '';
        expectedValues.forEach((val, idx) => {
            const h = HEARTS[idx];
            gridHtml += `
                <div class="exp-item">
                    <span class="exp-icon">${h.label}</span>
                    <div class="exp-val">${val.toFixed(2)}</div>
                    <div class="exp-label">å€‹</div>
                </div>
            `;
        });
        expectationGrid.innerHTML = gridHtml;

        // å…¨é€šã‚Šæ•°è¡¨ç¤ºï¼ˆBigIntã®æ•´å½¢ï¼‰
        let totalStr = totalCombinations.toString();
        if (totalStr.length > 15) {
            // æŒ‡æ•°è¡¨è¨˜é¢¨ã«çŸ­ç¸®
            totalStr = totalStr[0] + "." + totalStr.substring(1, 3) + "e+" + (totalStr.length - 1);
        }
        totalCases.textContent = totalStr;
    }
</script>

</body>
</html>