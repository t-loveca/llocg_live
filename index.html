<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<meta property="og:image" content="favicon.png">
<meta property="og:description" content="ãƒ©ãƒ–ã‚«ã®ãƒ©ã‚¤ãƒ–æˆåŠŸç‡ã‚’è¨ˆç®—ã—ã¾ã™ã€‚">
<title>ãƒ©ã‚¤ãƒ–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<style>
  :root{
    --bg:#fafafa; --card:#ffffff; --ink:#1b1f24; --sub:#60666d;
    --accent:#ff6a00; --ok:#0a7f45; --warn:#b54708; --muted:#e9ecef;
    --btn:#111; --btn-ink:#fff;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  .wrap{max-width:960px;margin:0 auto;padding-bottom:96px;}
  header{position:sticky;top:0;background:linear-gradient(180deg,#fff,rgba(255,255,255,.9));backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid #eee;z-index:10}
  header .inner{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;}
  h1{font-size:18px;margin:0;}
  .card{background:var(--card);border:1px solid #eee;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:12px;margin:12px 16px;}
  .card h2{font-size:16px;margin:0 0 8px 0;}
  .grid{display:grid;gap:8px;}
  .g2{grid-template-columns:1fr 1fr;}
  .g3{grid-template-columns:1fr 1fr 1fr;}
  .row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border-radius:10px;background:#fff;border:1px solid #eee;}
  .label{display:flex;align-items:center;gap:8px;font-size:14px;}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #ddd;border-radius:999px;padding:2px 8px;font-size:13px;background:#fff;}
  .count{display:flex;align-items:center;gap:6px;}
  .count input{width:62px;text-align:right;padding:6px 8px;border:1px solid #ddd;border-radius:8px;background:#fff;font-size:14px;}
  .steppers{display:flex;gap:4px;}
  button.icon{inline-size:36px;block-size:36px;border-radius:10px;border:1px solid #ddd;background:#fff;font-weight:700;font-size:18px;line-height:0;display:grid;place-items:center}
  button.icon:active{transform:translateY(1px)}
  input[type="number"]{appearance:textfield;}
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{appearance:none;margin:0;}
  .note{color:var(--sub);font-size:12px;}
  .totals{display:flex;gap:12px;flex-wrap:wrap;font-size:13px;color:var(--sub);}
  .ok{color:var(--ok)} .warn{color:var(--warn)}
  .stickybar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #eee;padding:8px 12px;display:flex;gap:10px;align-items:center;justify-content:center;z-index:20}
  .primary{background:var(--accent);color:#fff;border:none;padding:12px 18px;border-radius:12px;font-weight:700;font-size:16px}
  .ghost{background:#fff;color:var(--ink);border:1px solid #ddd;padding:10px 14px;border-radius:10px}
  .result{background:#fff;border:1px dashed #ddd;border-radius:12px;padding:12px;margin-top:8px}
  .muted{background:var(--muted);}
  .cols{display:grid;gap:8px;grid-template-columns:1fr 1fr;}
  @media (max-width:720px){ .g3{grid-template-columns:1fr;} .cols{grid-template-columns:1fr;} }
  .small{font-size:12px}
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
  .divider{height:1px;background:#eee;margin:8px 0}
  .tiny-image {
    width: 1px;
    height: 1px;
  }
</style>
</head>
<body>
  <header><div class="inner">
    <h1>ãƒ©ã‚¤ãƒ–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
    <span class="note">LoveLive! OCG</span>
  </div></header>

  <div class="wrap" id="app">
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¸ -->
    <section class="card" id="stageCard">
      <h2>ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆæœ€å¤§3äººï¼‰</h2>
      <div class="note">å„ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒãƒ¼ãƒˆã¨ãƒ–ãƒ¬ãƒ¼ãƒ‰æ•°ã‚’è¨­å®š</div>
      <div class="grid g3" id="stageArea"></div>
    </section>

    <!-- ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ -->
    <section class="card" id="liveCard">
      <h2>ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ï¼ˆæœ€å¤§3æšï¼‰</h2>
      <div class="note">å„ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ã®è¦æ±‚ãƒãƒ¼ãƒˆæ•°ã‚’æŒ‡å®š</div>
      <div class="grid g3" id="liveArea"></div>
    </section>

    <!-- ãƒ–ãƒ¬ãƒ¼ãƒ‰ãƒ‡ãƒƒã‚­ -->
    <section class="card">
      <h2>ãƒ‡ãƒƒã‚­ã®æ§‹æˆ</h2>
      <div class="note">ã‚¨ãƒ¼ãƒ«ã§ã‚ãã‚‹ãƒ‡ãƒƒã‚­ã®å†…è¨³</div>
      <div class="grid g3" id="deckArea"></div>
      <div class="totals" id="deckTotals"></div>
    </section>

    <!-- çµæœ -->
    <section class="card">
      <h2>çµæœ</h2>
      <div id="results" class="result">
        <div class="note">ä¸‹ã®ã€Œè¨ˆç®—ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
      </div>
      <div id="breakdown" class="result" style="margin-top:8px;display:none"></div>
    </section>
  </div>

  <div class="stickybar">
    <button class="primary" id="runBtn">è¨ˆç®—ã™ã‚‹</button>
    <button class="ghost" id="clearBtn">å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

<script>
/* ===== ã‚«ãƒ†ã‚´ãƒªå®šç¾© ===== */
const COLORS = [
  {key:'01', name:'æ¡ƒ',  emo:'ğŸ’—'},
  {key:'02', name:'èµ¤',  emo:'â¤ï¸'},
  {key:'03', name:'é»„',  emo:'ğŸ’›'},
  {key:'04', name:'ç·‘',  emo:'ğŸ’š'},
  {key:'05', name:'é’',  emo:'ğŸ’™'},
  {key:'06', name:'ç´«',  emo:'ğŸ’œ'},
];
const ALL = {key:'ALL', name:'', badge:'ALL'};
const ANY = {key:'00',  name:'ç„¡', emo:'ğŸ–¤'};
const NONE= {key:'NONE',name:'BHãªã—', badge:'â€“'};
const SU  = {key:'SU',  name:'ã‚¹ã‚³ã‚¢ã‚¢ãƒƒãƒ—', badge:'â™ª'};

/* ===== UIéƒ¨å“ ===== */
function makeStepper(id, value=0, min=0, max=999, step=1){
  return `<div class="count">
    <div class="steppers"><button class="icon" data-stepp="${id}" data-d="-${step}">âˆ’</button></div>
    <input type="number" id="${id}" value="${value}" min="${min}" max="${max}" step="${step}">
    <div class="steppers"><button class="icon" data-stepp="${id}" data-d="${step}">ï¼‹</button></div>
  </div>`;
}
function colorChip(c){return `<span class="chip">${c.emo} ${c.name}</span>`}
function badgeChip(b){return `<span class="chip"><span class="mono">${b}</span></span>`}

const stageArea = document.getElementById('stageArea');
const liveArea  = document.getElementById('liveArea');
const deckArea  = document.getElementById('deckArea');
const deckTotals= document.getElementById('deckTotals');

function stageBlock(i){
  const hearts = COLORS.map(c=>`
    <div class="row"><div class="label">${colorChip(c)}</div>${makeStepper(`s${i}_${c.key}`,0,0,20,1)}</div>
  `).join('');
  const all = `
    <div class="row"><div class="label">${badgeChip(ALL.badge)} ${ALL.name}</div>${makeStepper(`s${i}_${ALL.key}`,0,0,20,1)}</div>`;
  const blades = `
    <div class="row"><div class="label"><span class="chip">ãƒ–ãƒ¬ãƒ¼ãƒ‰æ•°</span></div>${makeStepper(`s${i}_BLD`,0,0,60,1)}</div>`;
  return `<div class="card muted"><h3 style="margin:0 0 6px 0;font-size:14px;">ãƒ¡ãƒ³ãƒãƒ¼ ${i+1}</h3><div class="grid">${hearts+all+blades}</div></div>`;
}
function liveBlock(i){
  const req = COLORS.map(c=>`
    <div class="row"><div class="label">${colorChip(c)}</div>${makeStepper(`l${i}_req_${c.key}`,0,0,40,1)}</div>
  `).join('');
  const any = `
    <div class="row"><div class="label"><span class="chip">${ANY.emo} ${ANY.name}</span></div>${makeStepper(`l${i}_req_${ANY.key}`,0,0,40,1)}</div>`;
  return `<div class="card muted"><h3 style="margin:0 0 6px 0;font-size:14px;">ãƒ©ã‚¤ãƒ– ${i+1}</h3><div class="grid">${req+any}</div></div>`;
}
function deckBlock(){
  const rows = [
    ...COLORS.map(c=>({label:`${colorChip(c)}`, id:`d_${c.key}`})),
    {label:`${badgeChip(ALL.badge)} ${ALL.name}`, id:`d_${ALL.key}`},
    {label:`${badgeChip(SU.badge)} ${SU.name}`, id:`d_${SU.key}`},
    {label:`${badgeChip('â€“')} ${NONE.name}`, id:`d_${NONE.key}`},
  ].map(r=>`
    <div class="row"><div class="label">${r.label}</div>${makeStepper(r.id,0,0,100,1)}</div>
  `).join('');
  return rows;
}
stageArea.innerHTML = [0,1,2].map(stageBlock).join('');
liveArea.innerHTML  = [0,1,2].map(liveBlock).join('');
deckArea.innerHTML  = deckBlock();

/* +- ãƒœã‚¿ãƒ³ */
document.addEventListener('click',(e)=>{
  const btn = e.target.closest('button[data-stepp]'); if(!btn) return;
  const id = btn.getAttribute('data-stepp'); const delta = Number(btn.getAttribute('data-d')||0);
  const input = document.getElementById(id); if(!input) return;
  const min = Number(input.min||'-Infinity'); const max = Number(input.max||'Infinity');
  let v = Number(input.value||0)+delta; v = Math.max(min, Math.min(max, v)); input.value = v;
  if(id.startsWith('d_')) updateDeckTotals();
});

/* ===== åˆè¨ˆè¡¨ç¤ºï¼ˆãƒ‡ãƒƒã‚­ï¼‰ ===== */
function num(id){ return Number(document.getElementById(id)?.value||0); }
function getDeckCounts(){
  const counts={ALL:0,SU:0,NONE:0}; COLORS.forEach(c=>counts[c.key]=num(`d_${c.key}`));
  counts.ALL=num(`d_${ALL.key}`); counts.SU=num(`d_${SU.key}`); counts.NONE=num(`d_${NONE.key}`); return counts;
}
function updateDeckTotals(){
  const counts=getDeckCounts();
  const total=Object.values(counts).reduce((a,b)=>a+b,0);
  const heartTotal = counts['ALL'] + COLORS.reduce((s,c)=>s+counts[c.key],0);
  deckTotals.innerHTML = `
    <span>åˆè¨ˆ <b>${total}</b> æš</span>
    <span>ãƒãƒ¼ãƒˆç·æ•° <b>${heartTotal}</b>ï¼ˆâ™ªã¨ãªã—ã‚’é™¤ãï¼‰</span>
    <span>â™ª <b>${counts['SU']}</b> ï¼ ãªã— <b>${counts['NONE']}</b></span>`;
}
updateDeckTotals();

/* ===== å…¥åŠ›å–å¾— ===== */
function getStage(){
  return [0,1,2].map(i=>{
    const hearts={}; COLORS.forEach(c=>hearts[c.key]=num(`s${i}_${c.key}`));
    hearts['ALL']=num(`s${i}_${ALL.key}`); const blades=num(`s${i}_BLD`);
    return {hearts,blades};
  });
}
function getLives(){
  return [0,1,2].map(i=>{
    const req={}; COLORS.forEach(c=>req[c.key]=num(`l${i}_req_${c.key}`));
    req['00']=num(`l${i}_req_${ANY.key}`); return {req};
  });
}

/* ===== å……è¶³åˆ¤å®š ===== */
function canSatisfy(req, have){
  let all = have.ALL|0;
  const leftover = {};
  for(const c of COLORS.map(x=>x.key)){
    const need = req[c]|0, own = have[c]|0;
    if(own >= need){ leftover[c] = own - need; }
    else{
      const d = need - own;
      if(all < d) return false;
      all -= d; leftover[c] = 0;
    }
  }
  const remColored = Object.values(leftover).reduce((a,b)=>a+b,0);
  return remColored + all >= (req['00']|0);
}

/* ===== çµ„åˆã› logC(n,k) ===== */
const logFact = [0];
function ensureLogFact(n){ for(let i=logFact.length;i<=n;i++) logFact[i]=logFact[i-1]+Math.log(i); }
const logCcache = new Map();
function logC(n,k){
  if(k<0||k>n) return -Infinity;
  const key=n+'_'+k; if(logCcache.has(key)) return logCcache.get(key);
  ensureLogFact(n); const r = logFact[n]-logFact[k]-logFact[n-k]; logCcache.set(key,r); return r;
}
function logSumExp(a,b){ if(a===-Infinity) return b; if(b===-Infinity) return a; const m=Math.max(a,b); return m+Math.log(Math.exp(a-m)+Math.log1p(Math.exp((b-m))))-Math.log(1); } // safe: but simplerã«å†å®šç¾©
function logSum(a,b){ if(a===-Infinity) return b; if(b===-Infinity) return a; const m=Math.max(a,b); return m + Math.log(Math.exp(a-m)+Math.exp(b-m)); }

/* ===== å³å¯†è¨ˆç®—ï¼ˆå¤šå¤‰é‡è¶…å¹¾ä½•ã®åˆç®—ï¼‰ ===== */
function computeExact(){
  const stage = getStage();
  const lives = getLives();
  const deck  = getDeckCounts();

  // ç·è¦æ±‚
  const req = {'00':0}; COLORS.forEach(c=>req[c.key]=0);
  for(const L of lives){ for(const k in req){ req[k] += (L.req[k]||0); } }

  const totalReq = Object.values(req).reduce((a,b)=>a+b,0);
  const n = stage.reduce((a,m)=>a+(m.blades||0),0); // æŠ½å‡ºæšæ•°

  const N_by = {}; COLORS.forEach(c=>N_by[c.key]=deck[c.key]|0);
  N_by['ALL']=deck['ALL']|0;
  const N_colorAll = COLORS.reduce((s,c)=>s+N_by[c.key],0) + N_by['ALL'];
  const N_SU = deck['SU']|0, N_NONE=deck['NONE']|0;
  const N_total = N_colorAll + N_SU + N_NONE;

  const errors=[];
  if(N_total<=0) errors.push('ãƒ‡ãƒƒã‚­æšæ•°ãŒ0ã§ã™ã€‚');
  if(n > N_total) errors.push(`ãƒ–ãƒ¬ãƒ¼ãƒ‰ç·æ•°(${n})ãŒãƒ‡ãƒƒã‚­æšæ•°(${N_total})ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
  if(totalReq===0) errors.push('ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ã®è¦æ±‚ãŒå…¨ã¦0ã§ã™ã€‚');
  if(errors.length) return {ok:false,errors};

  // ç›¤é¢ãƒãƒ¼ãƒˆï¼ˆå›ºå®šï¼‰
  const haveBase = {'ALL':0}; COLORS.forEach(c=>haveBase[c.key]=0);
  for(const m of stage){ for(const c of COLORS){ haveBase[c.key] += (m.hearts[c.key]|0); } haveBase.ALL += (m.hearts.ALL|0); }

  // n=0ã®å‡¦ç†ï¼šæœŸå¾…æšæ•°ã¯0ã€æˆåŠŸå¯å¦ã¯ç›¤é¢ã®ã¿ã§åˆ¤å®š
  if(n===0){
    const have = {...haveBase};
    const p = canSatisfy(req, have) ? 1 : 0;
    const exp = {};
    [...COLORS.map(c=>c.key),'ALL','SU','NONE'].forEach(k=>exp[k]=0);
    exp['00']=0;
    return {ok:true, p, blades:n, deckTotal:N_total, expected:exp};
  }

  const trackKeys = [...COLORS.map(c=>c.key), 'ALL']; // 7ã‚«ãƒ†ã‚´ãƒª
  const N_other = N_total - trackKeys.reduce((s,k)=>s+(N_by[k]|0),0); // SU+NONE
  const logDen = logC(N_total, n);

  let logSumSucc = -Infinity;
  const x = {}; trackKeys.forEach(k=>x[k]=0);

  function dfs(idx, taken, logW){
    if(idx===trackKeys.length){
      const x_other = n - taken;
      if(x_other<0 || x_other> N_other) return;
      const logW2 = logW + logC(N_other, x_other);

      const have = {'ALL': haveBase.ALL + (x['ALL']|0)};
      COLORS.forEach(c=>{ have[c.key] = haveBase[c.key] + (x[c.key]|0); });
      if(canSatisfy(req, have)) logSumSucc = logSum(logSumSucc, logW2);
      return;
    }
    const k = trackKeys[idx];
    const N_k = N_by[k]|0;
    const maxPick = Math.min(N_k, n - taken);
    for(let t=0; t<=maxPick; t++){
      x[k]=t;
      dfs(idx+1, taken + t, logW + logC(N_k, t));
    }
  }
  dfs(0, 0, 0);

  const p = (logSumSucc===-Infinity) ? 0 : Math.exp(logSumSucc - logDen);

  // æœŸå¾…å€‹æ•°ï¼ˆå³å¯†ï¼‰ E[X_i]=n*N_i/N
  const exp = {};
  trackKeys.forEach(k=>{ exp[k] = n * (N_by[k]|0) / N_total; });
  exp['SU']   = n * N_SU   / N_total;
  exp['NONE'] = n * N_NONE / N_total;
  exp['00']   = 0;

  return {ok:true, p, blades:n, deckTotal:N_total, expected:exp};
}

/* ===== è¡¨ç¤º ===== */
const resultsEl=document.getElementById('results');
const breakdownEl=document.getElementById('breakdown');
const pct = x => (x*100).toFixed(2)+'%';
const fmt = (x,d=6)=> Number(x).toFixed(d);

function renderBreakdown(exp){
  const rows = [
    ...COLORS.map(c=>[`${c.emo} ${c.name}`, exp[c.key]]),
    [`${ALL.badge} ${ALL.name}`,  exp.ALL],
    [`${SU.badge} ${SU.name}`,    exp.SU],
    [`â€“ ${NONE.name}`,            exp.NONE]

  ];
  breakdownEl.style.display='block';
  breakdownEl.innerHTML = `
    <div><b>ã‚¨ãƒ¼ãƒ«ã§ã‚ãã‚Œã‚‹æœŸå¾…æšæ•°</b></div>
    <table class="table" aria-label="æœŸå¾…æšæ•°">
      <thead><tr><th style="text-align:left">ãƒ–ãƒ¬ãƒ¼ãƒ‰ãƒãƒ¼ãƒˆ</th><th>æœŸå¾…æšæ•°</th></tr></thead>
      <tbody>
        ${rows.map(r=>`<tr><td style="text-align:left">${r[0]}</td><td>${fmt(r[1],2)}</td></tr>`).join('')}
      </tbody>
    </table>`;
}

function renderResult(r){
  if(!r.ok){
    breakdownEl.style.display='none';
    resultsEl.innerHTML = `<div class="note" style="color:#b54708">âš  å…¥åŠ›ã‚¨ãƒ©ãƒ¼ï¼š</div><ul class="small">${r.errors.map(e=>`<li>${e}</li>`).join('')}</ul>`;
    return;
  }
  resultsEl.innerHTML = `
    <div>
      <div><b>æˆåŠŸç¢ºç‡</b></div>
      <div style="font-size:24px;font-weight:800">${pct(r.p)}</div>
    </div>
    <div class="divider"></div>
    <div class="totals small"><span>ã‚¨ãƒ¼ãƒ«ç·æ•° <b>${r.blades}</b></span><span>ãƒ‡ãƒƒã‚­æšæ•° <b>${r.deckTotal}</b></span></div>
  `;
  renderBreakdown(r.expected);
}

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
document.getElementById('runBtn').addEventListener('click',()=>{ renderResult(computeExact()); });
document.getElementById('clearBtn').addEventListener('click',()=>{
  document.querySelectorAll('input[type="number"]').forEach(inp=>{ inp.value=0; });
  updateDeckTotals();
  resultsEl.innerHTML=`<div class="note">ä¸‹ã®ã€Œè¨ˆç®—ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>`;
  breakdownEl.style.display='none'; breakdownEl.innerHTML='';
});
</script>
</body>
</html>
